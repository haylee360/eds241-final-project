---
title: "Data check"
author: "Haylee Oyler"
format: html
execute:
  warning: false
  message: false
---

```{r}
#| code-fold: true
#| code-summary: "Load libraries"

library(haven)
library(tidyverse)
library(readtext)
library(here)
library(AER)
library(fixest)
library(gt)
library(jtools)
library(stargazer)
# library(modelsummary)
library(readr)
library(lfe)    
library(plm)    
```

```{r}
# Read stations and districts data
# stations <- read_dta(here("data", "rawraindata", "Station_Indonesia.dta"))
# districts <- read_dta(here("data", "rawraindata", "District_Indonesia.dta"))
# district_norms <- read_dta(here("data", "rawraindata", "districtnorms_nobirthyear.dta"))
# district_geocodes <- read_dta(here("data", "district_codes", "geocodes_distr.dta"))
# enum_areas <- read_dta(here("data", "district_codes", "enumerationareas", "enumerationareas93_99.dta"))
# 
# 
# # Load IFLS3 dataset
# ifls3 <- read_dta("data/IFLS3.dta")

# Load simulated rain data
rainfall <- read_csv(here("data", "Simulated_Data_MakeItRain.csv"))

```





```{r}
# Find district average rainfall for entire time period and log it
rainfall <- rainfall %>%
  group_by(district_id) %>% 
  mutate(avg_dist_rainfall = mean(rain_closest)) %>% 
  ungroup() %>% 
  # Need to shift average rainfall by minimum value to log transform it 
  mutate(avg_dist_rainfall = avg_dist_rainfall + abs(min(avg_dist_rainfall)) + 1,
         lavg_dist_rainfall = log(avg_dist_rainfall))

```

```{r}
# List of columns to loop through
rainfall_columns <- c("rain_closest", "rain_2nd", "rain_3rd", "rain_4th", "rain_5th")

for (col in rainfall_columns) {
  # Shift by the minimum value and a small constant (epsilon)
  min_value <- min(rainfall[[col]], na.rm = TRUE) 
  epsilon <- 1  # Small positive constant to avoid log(0)

  rainfall[[paste0("shift_", col)]] <- rainfall[[col]] - min_value + epsilon
  
  # Apply log transformation
  rainfall[[paste0("lshift_", col)]] <- log(rainfall[[paste0("shift_", col)]])
  
  # Difference in log district rainfall from mean district rainfall
  rainfall[paste0("ldev_", col)] = rainfall[paste0("lshift_", col)] - rainfall['lavg_dist_rainfall']

}

```

```{r}
# Create fixed effect levels for the interactions of district and season, and year and season
rainfall <- rainfall %>%
  mutate(district_season = paste0(district_id, "_", season),
         birthyear_season = paste0(birth_year, "_", season))

# Run FE regression with complete dataset
first_stage <- feols(height ~ ldev_rain_2nd + ldev_rain_3rd + ldev_rain_4th + ldev_rain_5th | district_season + birthyear_season,
                     cluster = ~province, 
                     data = rainfall)
summary(first_stage)

```


```{r}
# Split data to men and women
female_data <- rainfall %>% filter(female == 1)
male_data <- rainfall %>% 
  filter(female == 0) %>% 
  # Height was all the same for men, so randomly simulating here
  mutate(height = rnorm(n = 2023, mean = 162, sd = 0.5))


# Run first stage + fixed effects regression for women
first_stage_female <- feols(height ~ ldev_rain_2nd + ldev_rain_3rd + ldev_rain_4th + ldev_rain_5th | district_season + birthyear_season,
                     cluster = ~province, 
                     data = female_data)
summary(first_stage_female)


# Run first stage + fixed effects regression for men
first_stage_male <- feols(height ~ ldev_rain_2nd + ldev_rain_3rd + ldev_rain_4th + ldev_rain_5th | district_season + birthyear_season,
                     cluster = ~province, 
                     data = male_data)
summary(first_stage_male)
export_summs(first_stage_female, digits = 3, statistics = "none",
             model.names = c("Outcome: Turbine Proposal"))

```


Use AER to run the IV regression
```{r}

fit_2sls <- ivreg(height ~ # OUTCOME
                    lshift_rain_closest + # TREATMENT 
                    district_season +  birthyear_season |   # FIXED EFFECT 
                    ldev_rain_2nd + # INSTRUMENT
                    district_season + birthyear_season, # CONTROLS REPEATED..., 
                data = female_data, 
                cluster = ~province)

summary(fit_2sls)

```











